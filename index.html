<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz B√≠blico Multiplayer - Sala Corrigida</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        header {
            background-color: #4a00e0;
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .screen {
            padding: 30px;
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        
        .active {
            display: block;
        }
        
        #start-screen {
            text-align: center;
        }
        
        #start-screen p {
            margin: 20px 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .btn {
            background-color: #4a00e0;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }
        
        .btn:hover {
            background-color: #3600a3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #8e2de2;
        }
        
        .btn-success {
            background-color: #4CAF50;
        }
        
        .btn-danger {
            background-color: #F44336;
        }
        
        .question-container {
            margin-bottom: 20px;
        }
        
        .question-number {
            font-size: 1rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .question-text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .difficulty-facil {
            background-color: #4CAF50;
            color: white;
        }
        
        .difficulty-medio {
            background-color: #FF9800;
            color: white;
        }
        
        .difficulty-dificil {
            background-color: #F44336;
            color: white;
        }
        
        .difficulty-expert {
            background-color: #9C27B0;
            color: white;
        }
        
        .difficulty-mestre {
            background-color: #607D8B;
            color: white;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .option {
            background-color: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .option:hover {
            background-color: #e9e9e9;
            transform: scale(1.02);
        }
        
        .option.correct {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .option.wrong {
            background-color: #F44336;
            color: white;
            border-color: #F44336;
        }
        
        .timer-container {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .timer-bar {
            height: 100%;
            background-color: #4a00e0;
            width: 100%;
            transition: width 1s linear;
        }
        
        .score-container {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        #result-screen {
            text-align: center;
        }
        
        .result-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #4a00e0;
        }
        
        .score-display {
            font-size: 4rem;
            font-weight: bold;
            color: #4a00e0;
            margin: 20px 0;
        }
        
        .feedback {
            font-size: 1.3rem;
            margin: 20px 0;
        }
        
        .player-name {
            padding: 10px;
            font-size: 1.1rem;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            width: 100%;
            max-width: 300px;
            margin: 10px 0;
        }
        
        .players-panel {
            width: 300px;
            background-color: #f9f9f9;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .players-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4a00e0;
            text-align: center;
        }
        
        .players-list {
            list-style-type: none;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .player-name-display {
            font-weight: bold;
        }
        
        .player-score {
            color: #4a00e0;
            font-weight: bold;
        }
        
        .player-level {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #e0e0e0;
        }
        
        .room-code {
            background-color: #f0f0f0;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 5px;
            margin: 20px 0;
            display: inline-block;
        }
        
        .instructions {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #4a00e0;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .leaderboard {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 1.2rem;
        }
        
        .leaderboard-position {
            font-weight: bold;
            width: 40px;
        }
        
        .leaderboard-name {
            flex: 1;
            text-align: left;
            padding-left: 20px;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #4a00e0;
        }
        
        .level-info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .level-card {
            background-color: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            width: 180px;
            text-align: center;
        }
        
        .level-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .level-points {
            font-size: 0.9rem;
            color: #666;
        }
        
        .error-message {
            color: #F44336;
            margin: 10px 0;
            font-weight: bold;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 5px;
            border: 1px solid #f44336;
        }
        
        .success-message {
            color: #4CAF50;
            margin: 10px 0;
            font-weight: bold;
            padding: 10px;
            background-color: #e8f5e8;
            border-radius: 5px;
            border: 1px solid #4CAF50;
        }

        .player-count {
            font-size: 0.9rem;
            color: #666;
            margin: 10px 0;
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            
            .players-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid #e0e0e0;
                max-height: 200px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .level-info {
                justify-content: center;
            }
        }
        
        @media (max-width: 600px) {
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                height: auto;
                min-height: 90vh;
            }
            
            .level-card {
                width: 100%;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Quiz B√≠blico Multiplayer</h1>
            <div class="subtitle">M√°ximo de 10 jogadores por sala - Problema corrigido!</div>
        </header>
        
        <div class="main-content">
            <div id="start-screen" class="screen active">
                <h2>Bem-vindo ao Quiz B√≠blico Multiplayer!</h2>
                <p>Jogue com seus amigos em tempo real. M√°ximo de 10 jogadores por sala.</p>
                
                <div class="instructions">
                    <h3>Como entrar em uma sala:</h3>
                    <ol>
                        <li><strong>Anfitri√£o</strong>: Clique em "Criar Sala" e compartilhe o c√≥digo</li>
                        <li><strong>Jogadores</strong>: Clique em "Entrar em uma Sala" e digite o c√≥digo</li>
                        <li><strong>Nome</strong>: Digite seu nome antes de entrar</li>
                        <li><strong>C√≥digo</strong>: Use 4 letras mai√∫sculas (ex: ABCD)</li>
                    </ol>
                    <p class="player-count">üí° <strong>M√°ximo de 10 jogadores por sala</strong></p>
                </div>
                
                <button class="btn" id="host-btn">Criar Sala (Anfitri√£o)</button>
                <button class="btn btn-secondary" id="join-btn">Entrar em uma Sala</button>
            </div>
            
            <div id="host-screen" class="screen">
                <h2>Criar Sala de Jogo</h2>
                <div class="instructions">
                    <p>Digite seu nome e clique em "Criar Sala". Compartilhe o c√≥digo com os jogadores.</p>
                    <p class="player-count">üéØ <strong>M√°ximo de 10 jogadores por sala</strong></p>
                </div>
                <input type="text" class="player-name" id="host-name" placeholder="Seu nome como anfitri√£o" maxlength="15">
                <br>
                <button class="btn" id="create-room-btn">Criar Sala</button>
                <button class="btn btn-danger" id="back-host-btn">Voltar</button>
                
                <div id="room-created" style="display: none; text-align: center;">
                    <div class="success-message">‚úÖ Sala criada com sucesso!</div>
                    <div class="room-code" id="room-code-display">ABCD</div>
                    <p>Compartilhe este c√≥digo com os jogadores!</p>
                    <p class="player-count">üë• Jogadores na sala: <span id="current-player-count">1</span>/10</p>
                    
                    <div class="instructions">
                        <h3>Jogadores na sala:</h3>
                        <ul class="players-list" id="host-players-list">
                            <!-- Lista de jogadores ser√° inserida aqui -->
                        </ul>
                    </div>
                    
                    <button class="btn" id="start-game-btn" disabled>Iniciar Jogo (m√≠nimo 2 jogadores)</button>
                </div>
            </div>
            
            <div id="join-screen" class="screen">
                <h2>Entrar em uma Sala</h2>
                <div class="instructions">
                    <p>Digite seu nome e o c√≥digo da sala fornecida pelo anfitri√£o.</p>
                    <p class="player-count">üéØ <strong>M√°ximo de 10 jogadores por sala</strong></p>
                </div>
                <input type="text" class="player-name" id="player-name-input" placeholder="Seu nome" maxlength="15">
                <br>
                <input type="text" class="player-name" id="room-code-input" placeholder="C√≥digo da sala (ex: ABCD)" maxlength="4" style="text-transform: uppercase;">
                <br>
                <button class="btn" id="join-room-btn">Entrar na Sala</button>
                <button class="btn btn-danger" id="back-join-btn">Voltar</button>
                
                <div id="error-message" class="error-message" style="display: none;"></div>
                
                <div id="joined-room" style="display: none; text-align: center;">
                    <div class="success-message">‚úÖ Voc√™ entrou na sala com sucesso!</div>
                    <p>Aguardando o anfitri√£o iniciar o jogo...</p>
                    <p class="player-count">üë• Jogadores na sala: <span id="join-player-count">1</span>/10</p>
                    
                    <div class="instructions">
                        <h3>Jogadores na sala:</h3>
                        <ul class="players-list" id="join-players-list">
                            <!-- Lista de jogadores ser√° inserida aqui -->
                        </ul>
                    </div>
                    <div id="waiting-message">‚è≥ Aguardando anfitri√£o iniciar o jogo...</div>
                </div>
            </div>
            
            <div id="game-screen" class="screen">
                <div class="score-container">
                    Sua pontua√ß√£o: <span id="score">0</span> | 
                    N√≠vel: <span id="current-level">1 - Iniciante</span> |
                    Jogadores: <span id="game-player-count">1</span>/10
                </div>
                <div class="question-container">
                    <div class="question-number">Pergunta <span id="current-question">1</span> de <span id="total-questions">5</span></div>
                    <div class="question-text" id="question-text">Qual √© a pergunta?</div>
                </div>
                <div class="timer-container">
                    <div class="timer-bar" id="timer-bar"></div>
                </div>
                <div class="options-container" id="options-container">
                    <!-- As op√ß√µes ser√£o inseridas aqui via JavaScript -->
                </div>
            </div>
            
            <div id="result-screen" class="screen">
                <h2 class="result-title">Fim de Jogo!</h2>
                <div class="score-display" id="final-score">0</div>
                <div class="feedback" id="feedback">Mensagem de feedback</div>
                
                <div class="leaderboard">
                    <h3>Classifica√ß√£o Final</h3>
                    <div id="leaderboard-container">
                        <!-- A classifica√ß√£o ser√° inserida aqui -->
                    </div>
                </div>
                
                <button class="btn" id="back-to-lobby-btn">Voltar ao In√≠cio</button>
            </div>
            
            <div class="players-panel" id="players-panel" style="display: none;">
                <div class="players-title">Jogadores na Sala (<span id="panel-player-count">1</span>/10)</div>
                <ul class="players-list" id="players-list">
                    <!-- Lista de jogadores ser√° inserida aqui -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Sistema de n√≠veis
        const levels = [
            { name: "Iniciante", minPoints: 0, maxPoints: 100, difficulty: "F√°cil", color: "facil" },
            { name: "Intermedi√°rio", minPoints: 101, maxPoints: 300, difficulty: "M√©dio", color: "medio" },
            { name: "Avan√ßado", minPoints: 301, maxPoints: 600, difficulty: "Dif√≠cil", color: "dificil" }
        ];

        // Perguntas do quiz organizadas por n√≠vel de dificuldade
        const questionsByLevel = {
            0: [ // N√≠vel 1 - Iniciante
                {
                    question: "Quantos disc√≠pulos Jesus escolheu?",
                    options: ["7", "10", "12", "15"],
                    correct: 2,
                    explanation: "Jesus escolheu 12 disc√≠pulos para estarem com Ele e para os enviar a pregar (Marcos 3:14)."
                },
                {
                    question: "Qual √© o primeiro livro da B√≠blia?",
                    options: ["√äxodo", "G√™nesis", "Mateus", "J√≥"],
                    correct: 1,
                    explanation: "G√™nesis √© o primeiro livro da B√≠blia, que narra a cria√ß√£o do mundo."
                },
                {
                    question: "Quem construiu a arca?",
                    options: ["Mois√©s", "Abra√£o", "No√©", "Davi"],
                    correct: 2,
                    explanation: "No√© construiu a arca por ordem de Deus para salvar sua fam√≠lia e os animais do dil√∫vio (G√™nesis 6:14)."
                },
                {
                    question: "Quem foi engolido por um grande peixe?",
                    options: ["Jonas", "Pedro", "Paulo", "Jo√£o"],
                    correct: 0,
                    explanation: "Jonas foi engolido por um grande peixe quando tentou fugir da miss√£o que Deus lhe deu (Jonas 1:17)."
                },
                {
                    question: "Qual era o nome do irm√£o de Mois√©s?",
                    options: ["Josu√©", "Ar√£o", "Calebe", "Eli"],
                    correct: 1,
                    explanation: "Ar√£o era o irm√£o mais velho de Mois√©s e foi seu porta-voz diante do Fara√≥ (√äxodo 4:14)."
                }
            ],
            1: [ // N√≠vel 2 - Intermedi√°rio
                {
                    question: "Quem foi jogado na cova dos le√µes por orar a Deus?",
                    options: ["Jos√©", "Davi", "Daniel", "Jonas"],
                    correct: 2,
                    explanation: "Daniel foi jogado na cova dos le√µes por continuar orando a Deus, desobedecendo ao decreto real (Daniel 6:16)."
                },
                {
                    question: "Qual foi o primeiro milagre de Jesus?",
                    options: ["Multiplica√ß√£o dos p√£es", "Cura do cego", "Transforma√ß√£o de √°gua em vinho", "Ressurrei√ß√£o de L√°zaro"],
                    correct: 2,
                    explanation: "O primeiro milagre de Jesus foi transformar √°gua em vinho nas bodas de Can√° (Jo√£o 2:1-11)."
                },
                {
                    question: "Quem negou Jesus tr√™s vezes antes do galo cantar?",
                    options: ["Judas", "Tom√©", "Pedro", "Jo√£o"],
                    correct: 2,
                    explanation: "Pedro negou Jesus tr√™s vezes, conforme Jesus havia predito (Mateus 26:69-75)."
                }
            ],
            2: [ // N√≠vel 3 - Avan√ßado
                {
                    question: "Qual destes N√ÉO √© um livro do Novo Testamento?",
                    options: ["Atos", "√äxodo", "Romanos", "Apocalipse"],
                    correct: 1,
                    explanation: "√äxodo √© um livro do Antigo Testamento, que conta a sa√≠da dos israelitas do Egito."
                },
                {
                    question: "Quem foi o primeiro rei de Israel?",
                    options: ["Davi", "Salom√£o", "Saul", "Josu√©"],
                    correct: 2,
                    explanation: "Saul foi o primeiro rei de Israel, ungido pelo profeta Samuel (1 Samuel 10:1)."
                }
            ]
        };

        // Elementos do DOM
        const startScreen = document.getElementById('start-screen');
        const hostScreen = document.getElementById('host-screen');
        const joinScreen = document.getElementById('join-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const playersPanel = document.getElementById('players-panel');
        
        const hostBtn = document.getElementById('host-btn');
        const joinBtn = document.getElementById('join-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        const backHostBtn = document.getElementById('back-host-btn');
        const backJoinBtn = document.getElementById('back-join-btn');
        
        const hostNameInput = document.getElementById('host-name');
        const playerNameInput = document.getElementById('player-name-input');
        const roomCodeInput = document.getElementById('room-code-input');
        
        const roomCreatedDiv = document.getElementById('room-created');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const hostPlayersList = document.getElementById('host-players-list');
        const currentPlayerCount = document.getElementById('current-player-count');
        
        const joinedRoomDiv = document.getElementById('joined-room');
        const joinPlayersList = document.getElementById('join-players-list');
        const joinPlayerCount = document.getElementById('join-player-count');
        const waitingMessage = document.getElementById('waiting-message');
        const errorMessage = document.getElementById('error-message');
        
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreDisplay = document.getElementById('score');
        const finalScoreDisplay = document.getElementById('final-score');
        const feedbackDisplay = document.getElementById('feedback');
        const currentQuestionDisplay = document.getElementById('current-question');
        const totalQuestionsDisplay = document.getElementById('total-questions');
        const timerBar = document.getElementById('timer-bar');
        const playersList = document.getElementById('players-list');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const currentLevelDisplay = document.getElementById('current-level');
        const gamePlayerCount = document.getElementById('game-player-count');
        const panelPlayerCount = document.getElementById('panel-player-count');

        // Vari√°veis do jogo
        let currentQuestionIndex = 0;
        let score = 0;
        let timeLeft = 15;
        let timer;
        let playerName = "";
        let roomCode = "";
        let isHost = false;
        let players = [];
        let gameState = "lobby";
        let currentLevel = 0;
        let questions = [];
        let roomUpdateInterval;

        // Servidor corrigido - SIMULA√á√ÉO DE BACKEND
        const gameServer = {
            rooms: new Map(),
            MAX_PLAYERS: 10,
            
            createRoom(hostName) {
                const code = this.generateRoomCode();
                const room = {
                    host: hostName,
                    players: [hostName],
                    gameState: "lobby",
                    scores: { [hostName]: 0 },
                    levels: { [hostName]: 0 },
                    createdAt: Date.now()
                };
                
                this.rooms.set(code, room);
                console.log(`‚úÖ Sala criada: ${code} por ${hostName}`);
                return { success: true, code: code };
            },
            
            joinRoom(code, playerName) {
                console.log(`Tentando entrar na sala: ${code} como ${playerName}`);
                
                // Verificar se a sala existe
                if (!this.rooms.has(code)) {
                    console.log(`‚ùå Sala n√£o encontrada: ${code}`);
                    return { 
                        success: false, 
                        error: "Sala n√£o encontrada. Verifique o c√≥digo." 
                    };
                }
                
                const room = this.rooms.get(code);
                
                // Verificar se o jogador j√° est√° na sala
                if (room.players.includes(playerName)) {
                    console.log(`‚ùå Jogador j√° est√° na sala: ${playerName}`);
                    return { 
                        success: false, 
                        error: "Voc√™ j√° est√° nesta sala." 
                    };
                }
                
                // Verificar limite de jogadores
                if (room.players.length >= this.MAX_PLAYERS) {
                    console.log(`‚ùå Sala lotada: ${code} (${room.players.length}/${this.MAX_PLAYERS})`);
                    return { 
                        success: false, 
                        error: `Sala lotada! M√°ximo de ${this.MAX_PLAYERS} jogadores.` 
                    };
                }
                
                // Adicionar jogador √† sala
                room.players.push(playerName);
                room.scores[playerName] = 0;
                room.levels[playerName] = 0;
                
                console.log(`‚úÖ Jogador entrou: ${playerName} na sala ${code}`);
                console.log(`üë• Agora h√° ${room.players.length} jogadores na sala`);
                
                return { 
                    success: true, 
                    room: JSON.parse(JSON.stringify(room)) // Deep copy para evitar refer√™ncias
                };
            },
            
            getRoom(code) {
                if (!this.rooms.has(code)) {
                    console.log(`‚ùå Tentativa de acessar sala inexistente: ${code}`);
                    return null;
                }
                
                const room = this.rooms.get(code);
                return JSON.parse(JSON.stringify(room)); // Retorna c√≥pia para evitar muta√ß√£o
            },
            
            generateRoomCode() {
                const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                let result = "";
                for (let i = 0; i < 4; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                // Garantir que o c√≥digo seja √∫nico
                if (this.rooms.has(result)) {
                    return this.generateRoomCode();
                }
                
                return result;
            },
            
            startGame(code) {
                if (!this.rooms.has(code)) {
                    console.log(`‚ùå N√£o foi poss√≠vel iniciar jogo: sala ${code} n√£o existe`);
                    return false;
                }
                
                const room = this.rooms.get(code);
                room.gameState = "playing";
                console.log(`üéÆ Jogo iniciado na sala: ${code}`);
                return true;
            },
            
            submitAnswer(code, playerName, answerData) {
                if (!this.rooms.has(code)) return false;
                
                const room = this.rooms.get(code);
                
                // Simular processamento de resposta
                const points = answerData.correct ? 
                    Math.max(1, Math.floor(answerData.timeLeft / 3)) * (answerData.level + 1) : 0;
                
                if (answerData.correct) {
                    room.scores[playerName] += points;
                    
                    // Atualizar n√≠vel
                    const playerScore = room.scores[playerName];
                    for (let i = levels.length - 1; i >= 0; i--) {
                        if (playerScore >= levels[i].minPoints) {
                            room.levels[playerName] = i;
                            break;
                        }
                    }
                }
                
                return true;
            },
            
            // Limpar salas antigas (manuten√ß√£o)
            cleanupOldRooms() {
                const now = Date.now();
                const ONE_HOUR = 60 * 60 * 1000;
                
                for (let [code, room] of this.rooms.entries()) {
                    if (now - room.createdAt > ONE_HOUR) {
                        this.rooms.delete(code);
                        console.log(`üßπ Sala limpa: ${code}`);
                    }
                }
            }
        };

        // Executar limpeza a cada 5 minutos
        setInterval(() => gameServer.cleanupOldRooms(), 5 * 60 * 1000);

        // Determinar n√≠vel atual
        function getCurrentLevel(points) {
            for (let i = levels.length - 1; i >= 0; i--) {
                if (points >= levels[i].minPoints) {
                    return i;
                }
            }
            return 0;
        }

        // Atualizar display do n√≠vel
        function updateLevelDisplay() {
            const room = gameServer.getRoom(roomCode);
            if (!room) return;
            
            const playerScore = room.scores[playerName] || 0;
            currentLevel = getCurrentLevel(playerScore);
            currentLevelDisplay.textContent = `${currentLevel + 1} - ${levels[currentLevel].name}`;
        }

        // Atualizar contador de jogadores
        function updatePlayerCounts(room) {
            if (!room) return;
            
            const playerCount = room.players.length;
            currentPlayerCount.textContent = playerCount;
            joinPlayerCount.textContent = playerCount;
            gamePlayerCount.textContent = playerCount;
            panelPlayerCount.textContent = playerCount;
        }

        // Inicializar o quiz como anfitri√£o
        function hostGame() {
            playerName = hostNameInput.value.trim();
            if (!playerName) {
                showError("Por favor, digite seu nome");
                return;
            }
            
            const result = gameServer.createRoom(playerName);
            if (!result.success) {
                showError("Erro ao criar sala. Tente novamente.");
                return;
            }
            
            roomCode = result.code;
            isHost = true;
            
            // Atualizar interface
            roomCodeDisplay.textContent = roomCode;
            roomCreatedDiv.style.display = "block";
            updatePlayersList();
            
            // Mudar para tela de host
            startScreen.classList.remove('active');
            hostScreen.classList.add('active');
            playersPanel.style.display = "block";
            
            // Iniciar atualiza√ß√£o peri√≥dica da sala
            startRoomUpdates();
        }

        // Entrar em uma sala como jogador
        function joinGame() {
            playerName = playerNameInput.value.trim();
            roomCode = roomCodeInput.value.trim().toUpperCase();
            
            if (!playerName) {
                showError("Por favor, digite seu nome");
                return;
            }
            
            if (!roomCode || roomCode.length !== 4) {
                showError("Por favor, digite um c√≥digo de sala v√°lido (4 letras)");
                return;
            }
            
            const result = gameServer.joinRoom(roomCode, playerName);
            if (!result.success) {
                showError(result.error);
                return;
            }
            
            // Sucesso ao entrar na sala
            hideError();
            joinedRoomDiv.style.display = "block";
            updatePlayersList(result.room);
            
            // Mudar para tela de jogador
            startScreen.classList.remove('active');
            joinScreen.classList.add('active');
            playersPanel.style.display = "block";
            
            // Iniciar atualiza√ß√£o peri√≥dica da sala
            startRoomUpdates();
        }

        // Mostrar mensagem de erro
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = "block";
        }

        // Esconder mensagem de erro
        function hideError() {
            errorMessage.style.display = "none";
        }

        // Atualizar lista de jogadores
        function updatePlayersList(roomData = null) {
            const room = roomData || gameServer.getRoom(roomCode);
            if (!room) return;
            
            players = room.players;
            updatePlayerCounts(room);
            
            // Atualizar lista do host
            if (isHost) {
                hostPlayersList.innerHTML = '';
                players.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'player-item';
                    const playerLevel = room.levels[player] || 0;
                    li.innerHTML = `
                        <span class="player-name-display">${player}</span>
                        <span class="player-score">${room.scores[player] || 0}</span>
                    `;
                    hostPlayersList.appendChild(li);
                });
                
                // Habilitar bot√£o de iniciar se houver pelo menos 2 jogadores
                startGameBtn.disabled = players.length < 2;
                if (players.length < 2) {
                    startGameBtn.textContent = `Iniciar Jogo (m√≠nimo 2 jogadores)`;
                } else {
                    startGameBtn.textContent = `Iniciar Jogo (${players.length} jogadores)`;
                }
            }
            
            // Atualizar lista do jogador
            joinPlayersList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'player-item';
                const playerLevel = room.levels[player] || 0;
                li.innerHTML = `
                    <span class="player-name-display">${player}</span>
                    <span class="player-score">${room.scores[player] || 0}</span>
                `;
                joinPlayersList.appendChild(li);
            });
            
            // Atualizar painel lateral
            playersList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'player-item';
                const playerLevel = room.levels[player] || 0;
                li.innerHTML = `
                    <span class="player-name-display">${player}</span>
                    <span class="player-level difficulty-${levels[playerLevel].color}">Nv. ${playerLevel + 1}</span>
                    <span class="player-score">${room.scores[player] || 0}</span>
                `;
                playersList.appendChild(li);
            });
        }

        // Iniciar atualiza√ß√µes peri√≥dicas da sala
        function startRoomUpdates() {
            if (roomUpdateInterval) {
                clearInterval(roomUpdateInterval);
            }
            
            roomUpdateInterval = setInterval(() => {
                const room = gameServer.getRoom(roomCode);
                if (!room) {
                    // Sala n√£o existe mais
                    clearInterval(roomUpdateInterval);
                    alert("A sala foi fechada ou n√£o existe mais.");
                    backToStart();
                    return;
                }
                
                updatePlayersList(room);
                
                // Verificar se o jogo come√ßou
                if (room.gameState === "playing" && gameState === "lobby") {
                    gameState = "playing";
                    startGame();
                }
                
                // Verificar se o jogo terminou
                if (room.gameState === "results" && gameState === "playing") {
                    gameState = "results";
                    showResults();
                }
            }, 2000); // Atualizar a cada 2 segundos
        }

        // Iniciar o jogo (apenas anfitri√£o)
        function startGameAsHost() {
            if (!isHost) return;
            
            if (gameServer.startGame(roomCode)) {
                gameState = "playing";
                startGame();
            }
        }

        // Mostrar pergunta atual
        function startGame() {
            currentQuestionIndex = 0;
            score = 0;
            scoreDisplay.textContent = score;
            totalQuestionsDisplay.textContent = 5; // 5 perguntas por jogo
            
            hostScreen.classList.remove('active');
            joinScreen.classList.remove('active');
            gameScreen.classList.add('active');
            
            showQuestion();
        }

        function showQuestion() {
            const room = gameServer.getRoom(roomCode);
            if (!room) {
                alert("Erro: sala n√£o encontrada. Voltando ao in√≠cio.");
                backToStart();
                return;
            }
            
            const playerScore = room.scores[playerName] || 0;
            currentLevel = getCurrentLevel(playerScore);
            
            // Selecionar perguntas do n√≠vel atual
            questions = questionsByLevel[Math.min(currentLevel, 2)];
            
            const questionIndex = currentQuestionIndex % questions.length;
            const question = questions[questionIndex];
            questionText.textContent = question.question;
            currentQuestionDisplay.textContent = currentQuestionIndex + 1;
            
            // Atualizar display do n√≠vel
            updateLevelDisplay();
            
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.classList.add('option');
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => checkAnswer(index, question.correct));
                optionsContainer.appendChild(optionElement);
            });
            
            startTimer();
        }

        // Iniciar temporizador
        function startTimer() {
            timeLeft = 15;
            timerBar.style.width = '100%';
            timerBar.style.transition = 'width 15s linear';
            timerBar.style.width = '0%';
            
            timer = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    checkAnswer(-1, -1); // Tempo esgotado
                }
            }, 1000);
        }

        // Verificar resposta
        function checkAnswer(selectedIndex, correctIndex) {
            clearInterval(timer);
            
            const options = document.querySelectorAll('.option');
            const isCorrect = selectedIndex === correctIndex;
            
            // Mostrar resposta correta
            if (correctIndex >= 0) {
                options[correctIndex].classList.add('correct');
            }
            
            // Mostrar resposta errada
            if (selectedIndex >= 0 && !isCorrect) {
                options[selectedIndex].classList.add('wrong');
            }
            
            // Enviar resposta para o servidor
            gameServer.submitAnswer(roomCode, playerName, {
                correct: isCorrect,
                timeLeft: timeLeft,
                level: currentLevel
            });
            
            // Atualizar pontua√ß√£o local
            if (isCorrect) {
                const points = Math.max(1, Math.floor(timeLeft / 3)) * (currentLevel + 1);
                score += points;
                scoreDisplay.textContent = score;
            }
            
            // Pr√≥xima pergunta ap√≥s 2 segundos
            setTimeout(() => {
                currentQuestionIndex++;
                
                if (currentQuestionIndex < 5) { // 5 perguntas no total
                    showQuestion();
                } else {
                    // Finalizar jogo
                    if (isHost) {
                        const room = gameServer.getRoom(roomCode);
                        if (room) {
                            room.gameState = "results";
                        }
                    }
                    showResults();
                }
            }, 2000);
        }

        // Mostrar resultados
        function showResults() {
            gameScreen.classList.remove('active');
            resultScreen.classList.add('active');
            
            const room = gameServer.getRoom(roomCode);
            const playerScore = room ? room.scores[playerName] || 0 : score;
            
            finalScoreDisplay.textContent = playerScore;
            
            // Determinar feedback
            if (playerScore >= 100) {
                feedbackDisplay.textContent = `Parab√©ns, ${playerName}! Voc√™ √© um expert b√≠blico!`;
            } else if (playerScore >= 50) {
                feedbackDisplay.textContent = `Muito bom, ${playerName}! Voc√™ conhece bem a B√≠blia.`;
            } else {
                feedbackDisplay.textContent = `Bom trabalho, ${playerName}! Continue estudando a B√≠blia.`;
            }
            
            // Mostrar classifica√ß√£o
            showLeaderboard();
        }

        // Mostrar classifica√ß√£o
        function showLeaderboard() {
            const room = gameServer.getRoom(roomCode);
            if (!room) return;
            
            const sortedPlayers = Object.entries(room.scores)
                .sort((a, b) => b[1] - a[1]);
            
            leaderboardContainer.innerHTML = '';
            sortedPlayers.forEach(([player, score], index) => {
                const playerLevel = getCurrentLevel(score);
                const div = document.createElement('div');
                div.className = 'leaderboard-item';
                div.innerHTML = `
                    <div class="leaderboard-position">${index + 1}¬∫</div>
                    <div class="leaderboard-name">${player}</div>
                    <div class="leaderboard-score">${score}</div>
                `;
                leaderboardContainer.appendChild(div);
            });
        }

        // Voltar ao in√≠cio
        function backToStart() {
            // Limpar intervalo de atualiza√ß√£o
            if (roomUpdateInterval) {
                clearInterval(roomUpdateInterval);
                roomUpdateInterval = null;
            }
            
            // Resetar estado do jogo
            gameState = "lobby";
            playersPanel.style.display = "none";
            
            // Voltar para tela inicial
            hostScreen.classList.remove('active');
            joinScreen.classList.remove('active');
            gameScreen.classList.remove('active');
            resultScreen.classList.remove('active');
            startScreen.classList.add('active');
            
            // Resetar formul√°rios
            roomCreatedDiv.style.display = "none";
            joinedRoomDiv.style.display = "none";
            hideError();
            
            // Resetar vari√°veis
            playerName = "";
            roomCode = "";
            isHost = false;
            players = [];
        }

        // Event listeners
        hostBtn.addEventListener('click', () => {
            startScreen.classList.remove('active');
            hostScreen.classList.add('active');
            hostNameInput.focus();
        });
        
        joinBtn.addEventListener('click', () => {
            startScreen.classList.remove('active');
            joinScreen.classList.add('active');
            playerNameInput.focus();
        });
        
        createRoomBtn.addEventListener('click', hostGame);
        joinRoomBtn.addEventListener('click', joinGame);
        startGameBtn.addEventListener('click', startGameAsHost);
        backToLobbyBtn.addEventListener('click', backToStart);
        backHostBtn.addEventListener('click', backToStart);
        backJoinBtn.addEventListener('click', backToStart);

        // Permitir enviar com Enter
        hostNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') hostGame();
        });
        
        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });
        
        roomCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });

        // Focar automaticamente nos campos de entrada
        if (hostNameInput) hostNameInput.focus();
    </script>
</body>
</html>