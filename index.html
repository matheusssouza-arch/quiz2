<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Bíblico Multiplayer - Correção de Salas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        header {
            background-color: #4a00e0;
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .screen {
            padding: 30px;
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        
        .active {
            display: block;
        }
        
        #start-screen {
            text-align: center;
        }
        
        #start-screen p {
            margin: 20px 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .btn {
            background-color: #4a00e0;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }
        
        .btn:hover {
            background-color: #3600a3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #8e2de2;
        }
        
        .btn-success {
            background-color: #4CAF50;
        }
        
        .btn-danger {
            background-color: #F44336;
        }
        
        .question-container {
            margin-bottom: 20px;
        }
        
        .question-number {
            font-size: 1rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .question-text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .difficulty-facil {
            background-color: #4CAF50;
            color: white;
        }
        
        .difficulty-medio {
            background-color: #FF9800;
            color: white;
        }
        
        .difficulty-dificil {
            background-color: #F44336;
            color: white;
        }
        
        .difficulty-expert {
            background-color: #9C27B0;
            color: white;
        }
        
        .difficulty-mestre {
            background-color: #607D8B;
            color: white;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .option {
            background-color: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .option:hover {
            background-color: #e9e9e9;
            transform: scale(1.02);
        }
        
        .option.correct {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .option.wrong {
            background-color: #F44336;
            color: white;
            border-color: #F44336;
        }
        
        .timer-container {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .timer-bar {
            height: 100%;
            background-color: #4a00e0;
            width: 100%;
            transition: width 1s linear;
        }
        
        .score-container {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        #result-screen {
            text-align: center;
        }
        
        .result-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #4a00e0;
        }
        
        .score-display {
            font-size: 4rem;
            font-weight: bold;
            color: #4a00e0;
            margin: 20px 0;
        }
        
        .feedback {
            font-size: 1.3rem;
            margin: 20px 0;
        }
        
        .player-name {
            padding: 10px;
            font-size: 1.1rem;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            width: 100%;
            max-width: 300px;
            margin: 10px 0;
        }
        
        .players-panel {
            width: 300px;
            background-color: #f9f9f9;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .players-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4a00e0;
            text-align: center;
        }
        
        .players-list {
            list-style-type: none;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .player-name-display {
            font-weight: bold;
        }
        
        .player-score {
            color: #4a00e0;
            font-weight: bold;
        }
        
        .player-level {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #e0e0e0;
        }
        
        .room-code {
            background-color: #f0f0f0;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 5px;
            margin: 20px 0;
            display: inline-block;
        }
        
        .instructions {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #4a00e0;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .leaderboard {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 1.2rem;
        }
        
        .leaderboard-position {
            font-weight: bold;
            width: 40px;
        }
        
        .leaderboard-name {
            flex: 1;
            text-align: left;
            padding-left: 20px;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #4a00e0;
        }
        
        .level-info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .level-card {
            background-color: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            width: 180px;
            text-align: center;
        }
        
        .level-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .level-points {
            font-size: 0.9rem;
            color: #666;
        }
        
        .error-message {
            color: #F44336;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .success-message {
            color: #4CAF50;
            margin: 10px 0;
            font-weight: bold;
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            
            .players-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid #e0e0e0;
                max-height: 200px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .level-info {
                justify-content: center;
            }
        }
        
        @media (max-width: 600px) {
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                height: auto;
                min-height: 90vh;
            }
            
            .level-card {
                width: 100%;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Quiz Bíblico Multiplayer</h1>
            <div class="subtitle">Problema de entrada nas salas corrigido!</div>
        </header>
        
        <div class="main-content">
            <div id="start-screen" class="screen active">
                <h2>Bem-vindo ao Quiz Bíblico Multiplayer!</h2>
                <p>Jogue com seus amigos em tempo real. O jogo fica mais difícil conforme seu ranking melhora!</p>
                
                <div class="instructions">
                    <h3>Como entrar em uma sala:</h3>
                    <ol>
                        <li><strong>Anfitrião</strong>: Clique em "Criar Sala" e compartilhe o código</li>
                        <li><strong>Jogadores</strong>: Clique em "Entrar em uma Sala" e digite o código</li>
                        <li><strong>Nome</strong>: Digite seu nome antes de entrar</li>
                        <li><strong>Código</strong>: Use letras maiúsculas (ex: ABCD)</li>
                    </ol>
                </div>
                
                <button class="btn" id="host-btn">Criar Sala (Anfitrião)</button>
                <button class="btn btn-secondary" id="join-btn">Entrar em uma Sala</button>
            </div>
            
            <div id="host-screen" class="screen">
                <h2>Criar Sala de Jogo</h2>
                <div class="instructions">
                    <p>Digite seu nome e clique em "Criar Sala". Compartilhe o código com os jogadores.</p>
                </div>
                <input type="text" class="player-name" id="host-name" placeholder="Seu nome como anfitrião" maxlength="15">
                <br>
                <button class="btn" id="create-room-btn">Criar Sala</button>
                <button class="btn btn-danger" id="back-host-btn">Voltar</button>
                
                <div id="room-created" style="display: none; text-align: center;">
                    <div class="success-message">Sala criada com sucesso!</div>
                    <div class="room-code" id="room-code-display">ABCD</div>
                    <p>Compartilhe este código com os jogadores!</p>
                    
                    <div class="instructions">
                        <h3>Jogadores na sala:</h3>
                        <ul class="players-list" id="host-players-list">
                            <!-- Lista de jogadores será inserida aqui -->
                        </ul>
                    </div>
                    
                    <button class="btn" id="start-game-btn" disabled>Iniciar Jogo</button>
                </div>
            </div>
            
            <div id="join-screen" class="screen">
                <h2>Entrar em uma Sala</h2>
                <div class="instructions">
                    <p>Digite seu nome e o código da sala fornecida pelo anfitrião.</p>
                </div>
                <input type="text" class="player-name" id="player-name-input" placeholder="Seu nome" maxlength="15">
                <br>
                <input type="text" class="player-name" id="room-code-input" placeholder="Código da sala (ex: ABCD)" maxlength="4" style="text-transform: uppercase;">
                <br>
                <button class="btn" id="join-room-btn">Entrar na Sala</button>
                <button class="btn btn-danger" id="back-join-btn">Voltar</button>
                
                <div id="error-message" class="error-message" style="display: none;"></div>
                
                <div id="joined-room" style="display: none; text-align: center;">
                    <div class="success-message">Você entrou na sala com sucesso!</div>
                    <p>Aguardando o anfitrião iniciar o jogo...</p>
                    <div class="instructions">
                        <h3>Jogadores na sala:</h3>
                        <ul class="players-list" id="join-players-list">
                            <!-- Lista de jogadores será inserida aqui -->
                        </ul>
                    </div>
                    <div id="waiting-message">Aguardando anfitrião iniciar o jogo...</div>
                </div>
            </div>
            
            <div id="game-screen" class="screen">
                <div class="score-container">
                    Sua pontuação: <span id="score">0</span> | 
                    Nível: <span id="current-level">1 - Iniciante</span>
                </div>
                <div class="question-container">
                    <div class="question-number">Pergunta <span id="current-question">1</span> de <span id="total-questions">10</span></div>
                    <div class="question-text" id="question-text">Qual é a pergunta?</div>
                </div>
                <div class="timer-container">
                    <div class="timer-bar" id="timer-bar"></div>
                </div>
                <div class="options-container" id="options-container">
                    <!-- As opções serão inseridas aqui via JavaScript -->
                </div>
            </div>
            
            <div id="result-screen" class="screen">
                <h2 class="result-title">Fim de Jogo!</h2>
                <div class="score-display" id="final-score">0</div>
                <div class="feedback" id="feedback">Mensagem de feedback</div>
                
                <div class="leaderboard">
                    <h3>Classificação Final</h3>
                    <div id="leaderboard-container">
                        <!-- A classificação será inserida aqui -->
                    </div>
                </div>
                
                <button class="btn" id="back-to-lobby-btn">Voltar ao Início</button>
            </div>
            
            <div class="players-panel" id="players-panel" style="display: none;">
                <div class="players-title">Jogadores na Sala</div>
                <ul class="players-list" id="players-list">
                    <!-- Lista de jogadores será inserida aqui -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Sistema de níveis
        const levels = [
            { name: "Iniciante", minPoints: 0, maxPoints: 100, difficulty: "Fácil", color: "facil" },
            { name: "Intermediário", minPoints: 101, maxPoints: 300, difficulty: "Médio", color: "medio" },
            { name: "Avançado", minPoints: 301, maxPoints: 600, difficulty: "Difícil", color: "dificil" },
            { name: "Expert", minPoints: 601, maxPoints: 1000, difficulty: "Expert", color: "expert" },
            { name: "Mestre", minPoints: 1001, maxPoints: Infinity, difficulty: "Mestre", color: "mestre" }
        ];

        // Perguntas do quiz organizadas por nível de dificuldade
        const questionsByLevel = {
            0: [ // Nível 1 - Iniciante
                {
                    question: "Quantos discípulos Jesus escolheu?",
                    options: ["7", "10", "12", "15"],
                    correct: 2,
                    explanation: "Jesus escolheu 12 discípulos para estarem com Ele e para os enviar a pregar (Marcos 3:14)."
                },
                {
                    question: "Qual é o primeiro livro da Bíblia?",
                    options: ["Êxodo", "Gênesis", "Mateus", "Jó"],
                    correct: 1,
                    explanation: "Gênesis é o primeiro livro da Bíblia, que narra a criação do mundo."
                },
                {
                    question: "Quem construiu a arca?",
                    options: ["Moisés", "Abraão", "Noé", "Davi"],
                    correct: 2,
                    explanation: "Noé construiu a arca por ordem de Deus para salvar sua família e os animais do dilúvio (Gênesis 6:14)."
                },
                {
                    question: "Quem foi engolido por um grande peixe?",
                    options: ["Jonas", "Pedro", "Paulo", "João"],
                    correct: 0,
                    explanation: "Jonas foi engolido por um grande peixe quando tentou fugir da missão que Deus lhe deu (Jonas 1:17)."
                },
                {
                    question: "Qual era o nome do irmão de Moisés?",
                    options: ["Josué", "Arão", "Calebe", "Eli"],
                    correct: 1,
                    explanation: "Arão era o irmão mais velho de Moisés e foi seu porta-voz diante do Faraó (Êxodo 4:14)."
                }
            ],
            1: [ // Nível 2 - Intermediário
                {
                    question: "Quem foi jogado na cova dos leões por orar a Deus?",
                    options: ["José", "Davi", "Daniel", "Jonas"],
                    correct: 2,
                    explanation: "Daniel foi jogado na cova dos leões por continuar orando a Deus, desobedecendo ao decreto real (Daniel 6:16)."
                },
                {
                    question: "Qual foi o primeiro milagre de Jesus?",
                    options: ["Multiplicação dos pães", "Cura do cego", "Transformação de água em vinho", "Ressurreição de Lázaro"],
                    correct: 2,
                    explanation: "O primeiro milagre de Jesus foi transformar água em vinho nas bodas de Caná (João 2:1-11)."
                },
                {
                    question: "Quem negou Jesus três vezes antes do galo cantar?",
                    options: ["Judas", "Tomé", "Pedro", "João"],
                    correct: 2,
                    explanation: "Pedro negou Jesus três vezes, conforme Jesus havia predito (Mateus 26:69-75)."
                },
                {
                    question: "Quem foi o primeiro mártir da igreja cristã?",
                    options: ["Pedro", "Paulo", "Estêvão", "Tiago"],
                    correct: 2,
                    explanation: "Estêvão foi o primeiro mártir da igreja cristã, apedrejado por sua fé (Atos 7:59-60)."
                },
                {
                    question: "Qual apóstolo era conhecido como 'o discípulo amado'?",
                    options: ["Pedro", "Tiago", "João", "André"],
                    correct: 2,
                    explanation: "João é frequentemente referido como 'o discípulo amado' nos evangelhos (João 13:23)."
                }
            ],
            2: [ // Nível 3 - Avançado
                {
                    question: "Qual destes NÃO é um livro do Novo Testamento?",
                    options: ["Atos", "Êxodo", "Romanos", "Apocalipse"],
                    correct: 1,
                    explanation: "Êxodo é um livro do Antigo Testamento, que conta a saída dos israelitas do Egito."
                },
                {
                    question: "Quem foi o primeiro rei de Israel?",
                    options: ["Davi", "Salomão", "Saul", "Josué"],
                    correct: 2,
                    explanation: "Saul foi o primeiro rei de Israel, ungido pelo profeta Samuel (1 Samuel 10:1)."
                },
                {
                    question: "Quem foi lançado no fogo por se recusar a adorar uma estátua?",
                    options: ["Sadraque, Mesaque e Abede-Nego", "Pedro, Tiago e João", "Abraão, Isaque e Jacó", "Paulo, Silas e Timóteo"],
                    correct: 0,
                    explanation: "Sadraque, Mesaque e Abede-Nego se recusaram a adorar a estátua de Nabucodonosor e foram lançados na fornalha (Daniel 3:19-23)."
                },
                {
                    question: "Quantos anos durou o dilúvio?",
                    options: ["40 dias e 40 noites", "100 dias", "1 ano", "7 dias"],
                    correct: 0,
                    explanation: "O dilúvio durou 40 dias e 40 noites (Gênesis 7:12)."
                },
                {
                    question: "Qual era o nome da mulher de Adão?",
                    options: ["Sara", "Eva", "Rebeca", "Lia"],
                    correct: 1,
                    explanation: "Eva foi a primeira mulher, criada por Deus como companheira para Adão (Gênesis 2:22)."
                }
            ]
        };

        // Elementos do DOM
        const startScreen = document.getElementById('start-screen');
        const hostScreen = document.getElementById('host-screen');
        const joinScreen = document.getElementById('join-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const playersPanel = document.getElementById('players-panel');
        
        const hostBtn = document.getElementById('host-btn');
        const joinBtn = document.getElementById('join-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        const backHostBtn = document.getElementById('back-host-btn');
        const backJoinBtn = document.getElementById('back-join-btn');
        
        const hostNameInput = document.getElementById('host-name');
        const playerNameInput = document.getElementById('player-name-input');
        const roomCodeInput = document.getElementById('room-code-input');
        
        const roomCreatedDiv = document.getElementById('room-created');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const hostPlayersList = document.getElementById('host-players-list');
        
        const joinedRoomDiv = document.getElementById('joined-room');
        const joinPlayersList = document.getElementById('join-players-list');
        const waitingMessage = document.getElementById('waiting-message');
        const errorMessage = document.getElementById('error-message');
        
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreDisplay = document.getElementById('score');
        const finalScoreDisplay = document.getElementById('final-score');
        const feedbackDisplay = document.getElementById('feedback');
        const currentQuestionDisplay = document.getElementById('current-question');
        const totalQuestionsDisplay = document.getElementById('total-questions');
        const timerBar = document.getElementById('timer-bar');
        const playersList = document.getElementById('players-list');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const currentLevelDisplay = document.getElementById('current-level');

        // Variáveis do jogo
        let currentQuestionIndex = 0;
        let score = 0;
        let timeLeft = 15;
        let timer;
        let playerName = "";
        let roomCode = "";
        let isHost = false;
        let players = [];
        let gameState = "lobby";
        let currentLevel = 0;
        let questions = [];
        let roomUpdateInterval;

        // Servidor simplificado e corrigido
        const gameServer = {
            rooms: new Map(),
            
            createRoom(hostName) {
                const code = this.generateRoomCode();
                const room = {
                    host: hostName,
                    players: [hostName],
                    gameState: "lobby",
                    scores: { [hostName]: 0 },
                    levels: { [hostName]: 0 }
                };
                this.rooms.set(code, room);
                console.log(`Sala criada: ${code} por ${hostName}`);
                return code;
            },
            
            joinRoom(code, playerName) {
                const room = this.rooms.get(code);
                if (!room) {
                    console.log(`Sala não encontrada: ${code}`);
                    return { success: false, error: "Sala não encontrada" };
                }
                
                if (room.players.includes(playerName)) {
                    console.log(`Jogador já está na sala: ${playerName}`);
                    return { success: false, error: "Você já está nesta sala" };
                }
                
                if (room.players.length >= 10) {
                    console.log(`Sala lotada: ${code}`);
                    return { success: false, error: "Sala lotada (máximo 10 jogadores)" };
                }
                
                room.players.push(playerName);
                room.scores[playerName] = 0;
                room.levels[playerName] = 0;
                
                console.log(`Jogador entrou: ${playerName} na sala ${code}`);
                return { success: true, room };
            },
            
            getRoom(code) {
                return this.rooms.get(code);
            },
            
            generateRoomCode() {
                const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                let result = "";
                for (let i = 0; i < 4; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                // Garantir que o código seja único
                if (this.rooms.has(result)) {
                    return this.generateRoomCode();
                }
                
                return result;
            },
            
            startGame(code) {
                const room = this.rooms.get(code);
                if (room) {
                    room.gameState = "playing";
                    return true;
                }
                return false;
            },
            
            submitAnswer(code, playerName, answerData) {
                const room = this.rooms.get(code);
                if (!room) return false;
                
                // Simular processamento de resposta
                const points = answerData.correct ? 
                    Math.max(1, Math.floor(answerData.timeLeft / 3)) * (answerData.level + 1) : 0;
                
                if (answerData.correct) {
                    room.scores[playerName] += points;
                    
                    // Atualizar nível
                    const playerScore = room.scores[playerName];
                    for (let i = levels.length - 1; i >= 0; i--) {
                        if (playerScore >= levels[i].minPoints) {
                            room.levels[playerName] = i;
                            break;
                        }
                    }
                }
                
                return true;
            }
        };

        // Determinar nível atual
        function getCurrentLevel(points) {
            for (let i = levels.length - 1; i >= 0; i--) {
                if (points >= levels[i].minPoints) {
                    return i;
                }
            }
            return 0;
        }

        // Atualizar display do nível
        function updateLevelDisplay() {
            const room = gameServer.getRoom(roomCode);
            if (!room) return;
            
            const playerScore = room.scores[playerName] || 0;
            currentLevel = getCurrentLevel(playerScore);
            currentLevelDisplay.textContent = `${currentLevel + 1} - ${levels[currentLevel].name}`;
        }

        // Inicializar o quiz como anfitrião
        function hostGame() {
            playerName = hostNameInput.value.trim();
            if (!playerName) {
                alert("Por favor, digite seu nome");
                return;
            }
            
            roomCode = gameServer.createRoom(playerName);
            isHost = true;
            
            // Atualizar interface
            roomCodeDisplay.textContent = roomCode;
            roomCreatedDiv.style.display = "block";
            updatePlayersList();
            
            // Mudar para tela de host
            startScreen.classList.remove('active');
            hostScreen.classList.add('active');
            playersPanel.style.display = "block";
            
            // Iniciar atualização periódica da sala
            startRoomUpdates();
        }

        // Entrar em uma sala como jogador
        function joinGame() {
            playerName = playerNameInput.value.trim();
            roomCode = roomCodeInput.value.trim().toUpperCase();
            
            if (!playerName) {
                showError("Por favor, digite seu nome");
                return;
            }
            
            if (!roomCode || roomCode.length !== 4) {
                showError("Por favor, digite um código de sala válido (4 letras)");
                return;
            }
            
            const result = gameServer.joinRoom(roomCode, playerName);
            if (!result.success) {
                showError(result.error);
                return;
            }
            
            // Sucesso ao entrar na sala
            hideError();
            joinedRoomDiv.style.display = "block";
            updatePlayersList();
            
            // Mudar para tela de jogador
            startScreen.classList.remove('active');
            joinScreen.classList.add('active');
            playersPanel.style.display = "block";
            
            // Iniciar atualização periódica da sala
            startRoomUpdates();
        }

        // Mostrar mensagem de erro
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = "block";
        }

        // Esconder mensagem de erro
        function hideError() {
            errorMessage.style.display = "none";
        }

        // Atualizar lista de jogadores
        function updatePlayersList() {
            const room = gameServer.getRoom(roomCode);
            if (!room) return;
            
            players = room.players;
            
            // Atualizar lista do host
            if (isHost) {
                hostPlayersList.innerHTML = '';
                players.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'player-item';
                    const playerLevel = room.levels[player] || 0;
                    li.innerHTML = `
                        <span class="player-name-display">${player}</span>
                        <span class="player-score">${room.scores[player] || 0}</span>
                    `;
                    hostPlayersList.appendChild(li);
                });
                
                // Habilitar botão de iniciar se houver pelo menos 2 jogadores
                startGameBtn.disabled = players.length < 2;
            }
            
            // Atualizar lista do jogador
            joinPlayersList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'player-item';
                const playerLevel = room.levels[player] || 0;
                li.innerHTML = `
                    <span class="player-name-display">${player}</span>
                    <span class="player-score">${room.scores[player] || 0}</span>
                `;
                joinPlayersList.appendChild(li);
            });
            
            // Atualizar painel lateral
            playersList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'player-item';
                const playerLevel = room.levels[player] || 0;
                li.innerHTML = `
                    <span class="player-name-display">${player}</span>
                    <span class="player-level difficulty-${levels[playerLevel].color}">Nv. ${playerLevel + 1}</span>
                    <span class="player-score">${room.scores[player] || 0}</span>
                `;
                playersList.appendChild(li);
            });
        }

        // Iniciar atualizações periódicas da sala
        function startRoomUpdates() {
            if (roomUpdateInterval) {
                clearInterval(roomUpdateInterval);
            }
            
            roomUpdateInterval = setInterval(() => {
                const room = gameServer.getRoom(roomCode);
                if (!room) {
                    // Sala não existe mais
                    clearInterval(roomUpdateInterval);
                    alert("A sala foi fechada");
                    backToStart();
                    return;
                }
                
                updatePlayersList();
                
                // Verificar se o jogo começou
                if (room.gameState === "playing" && gameState === "lobby") {
                    gameState = "playing";
                    startGame();
                }
                
                // Verificar se o jogo terminou
                if (room.gameState === "results" && gameState === "playing") {
                    gameState = "results";
                    showResults();
                }
            }, 1000);
        }

        // Iniciar o jogo (apenas anfitrião)
        function startGameAsHost() {
            if (!isHost) return;
            
            if (gameServer.startGame(roomCode)) {
                gameState = "playing";
                startGame();
            }
        }

        // Mostrar pergunta atual
        function startGame() {
            currentQuestionIndex = 0;
            score = 0;
            scoreDisplay.textContent = score;
            totalQuestionsDisplay.textContent = 5; // 5 perguntas por jogo
            
            hostScreen.classList.remove('active');
            joinScreen.classList.remove('active');
            gameScreen.classList.add('active');
            
            showQuestion();
        }

        function showQuestion() {
            const room = gameServer.getRoom(roomCode);
            if (!room) return;
            
            const playerScore = room.scores[playerName] || 0;
            currentLevel = getCurrentLevel(playerScore);
            
            // Selecionar perguntas do nível atual
            questions = questionsByLevel[Math.min(currentLevel, 2)]; // Máximo nível 2 por enquanto
            
            const questionIndex = currentQuestionIndex % questions.length;
            const question = questions[questionIndex];
            questionText.textContent = question.question;
            currentQuestionDisplay.textContent = currentQuestionIndex + 1;
            
            // Atualizar display do nível
            updateLevelDisplay();
            
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.classList.add('option');
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => checkAnswer(index, question.correct));
                optionsContainer.appendChild(optionElement);
            });
            
            startTimer();
        }

        // Iniciar temporizador
        function startTimer() {
            timeLeft = 15;
            timerBar.style.width = '100%';
            timerBar.style.transition = 'width 15s linear';
            timerBar.style.width = '0%';
            
            timer = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    checkAnswer(-1, -1); // Tempo esgotado
                }
            }, 1000);
        }

        // Verificar resposta
        function checkAnswer(selectedIndex, correctIndex) {
            clearInterval(timer);
            
            const options = document.querySelectorAll('.option');
            const isCorrect = selectedIndex === correctIndex;
            
            // Mostrar resposta correta
            if (correctIndex >= 0) {
                options[correctIndex].classList.add('correct');
            }
            
            // Mostrar resposta errada
            if (selectedIndex >= 0 && !isCorrect) {
                options[selectedIndex].classList.add('wrong');
            }
            
            // Enviar resposta para o servidor
            gameServer.submitAnswer(roomCode, playerName, {
                correct: isCorrect,
                timeLeft: timeLeft,
                level: currentLevel
            });
            
            // Atualizar pontuação local
            if (isCorrect) {
                const points = Math.max(1, Math.floor(timeLeft / 3)) * (currentLevel + 1);
                score += points;
                scoreDisplay.textContent = score;
            }
            
            // Próxima pergunta após 2 segundos
            setTimeout(() => {
                currentQuestionIndex++;
                
                if (currentQuestionIndex < 5) { // 5 perguntas no total
                    showQuestion();
                } else {
                    // Finalizar jogo
                    if (isHost) {
                        const room = gameServer.getRoom(roomCode);
                        if (room) {
                            room.gameState = "results";
                        }
                    }
                    showResults();
                }
            }, 2000);
        }

        // Mostrar resultados
        function showResults() {
            gameScreen.classList.remove('active');
            resultScreen.classList.add('active');
            
            const room = gameServer.getRoom(roomCode);
            const playerScore = room ? room.scores[playerName] || 0 : score;
            
            finalScoreDisplay.textContent = playerScore;
            
            // Determinar feedback
            if (playerScore >= 100) {
                feedbackDisplay.textContent = `Parabéns, ${playerName}! Você é um expert bíblico!`;
            } else if (playerScore >= 50) {
                feedbackDisplay.textContent = `Muito bom, ${playerName}! Você conhece bem a Bíblia.`;
            } else {
                feedbackDisplay.textContent = `Bom trabalho, ${playerName}! Continue estudando a Bíblia.`;
            }
            
            // Mostrar classificação
            showLeaderboard();
        }

        // Mostrar classificação
        function showLeaderboard() {
            const room = gameServer.getRoom(roomCode);
            if (!room) return;
            
            const sortedPlayers = Object.entries(room.scores)
                .sort((a, b) => b[1] - a[1]);
            
            leaderboardContainer.innerHTML = '';
            sortedPlayers.forEach(([player, score], index) => {
                const playerLevel = getCurrentLevel(score);
                const div = document.createElement('div');
                div.className = 'leaderboard-item';
                div.innerHTML = `
                    <div class="leaderboard-position">${index + 1}º</div>
                    <div class="leaderboard-name">${player}</div>
                    <div class="leaderboard-score">${score}</div>
                `;
                leaderboardContainer.appendChild(div);
            });
        }

        // Voltar ao início
        function backToStart() {
            // Limpar intervalo de atualização
            if (roomUpdateInterval) {
                clearInterval(roomUpdateInterval);
            }
            
            // Resetar estado do jogo
            gameState = "lobby";
            playersPanel.style.display = "none";
            
            // Voltar para tela inicial
            hostScreen.classList.remove('active');
            joinScreen.classList.remove('active');
            gameScreen.classList.remove('active');
            resultScreen.classList.remove('active');
            startScreen.classList.add('active');
            
            // Resetar formulários
            roomCreatedDiv.style.display = "none";
            joinedRoomDiv.style.display = "none";
            hideError();
        }

        // Event listeners
        hostBtn.addEventListener('click', () => {
            startScreen.classList.remove('active');
            hostScreen.classList.add('active');
        });
        
        joinBtn.addEventListener('click', () => {
            startScreen.classList.remove('active');
            joinScreen.classList.add('active');
        });
        
        createRoomBtn.addEventListener('click', hostGame);
        joinRoomBtn.addEventListener('click', joinGame);
        startGameBtn.addEventListener('click', startGameAsHost);
        backToLobbyBtn.addEventListener('click', backToStart);
        backHostBtn.addEventListener('click', backToStart);
        backJoinBtn.addEventListener('click', backToStart);

        // Permitir enviar com Enter
        hostNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') hostGame();
        });
        
        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });
        
        roomCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });

        // Focar automaticamente nos campos de entrada
        hostNameInput.focus();
    </script>
</body>
</html>